# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è NaN Loss –≤ –æ–±—É—á–µ–Ω–∏–∏

## üîß –ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

### 1. –°–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–π learning rate
- **–ë—ã–ª–æ**: `learning_rate: 1e-4`
- **–°—Ç–∞–ª–æ**: `learning_rate: 5e-5` (–≤ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏)
- **–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –≤–µ—Ä—Å–∏—è**: `learning_rate: 1e-5` (–≤ safe –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏)

### 2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ gradient clipping
- **–î–æ–±–∞–≤–ª–µ–Ω–æ**: `max_grad_norm: 1.0` (–æ—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
- **–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –≤–µ—Ä—Å–∏—è**: `max_grad_norm: 0.5` (–±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ clipping)

### 3. –ü—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π –≤–µ—Å–æ–≤
- **ID embeddings**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è `nn.init.normal_(weight, mean=0.0, std=0.02)`
- **Projection layers**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è `nn.init.xavier_uniform_()`
- **Fusion head**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö —Å–ª–æ–µ–≤

### 4. –ü—Ä–æ–±–ª–µ–º—ã —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Ç–µ–Ω–∑–æ—Ä–æ–≤
- **Collator**: –¢–µ–Ω–∑–æ—Ä—ã —Ç–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞—é—Ç—Å—è –Ω–∞ CPU –∏ –ø–µ—Ä–µ–º–µ—â–∞—é—Ç—Å—è –Ω–∞ GPU –≤ –º–æ–¥–µ–ª–∏
- **Forward pass**: –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ device placement –¥–ª—è id_ids
- **Gradient flow**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ NaN –ø–µ—Ä–µ–¥ backward pass

### 5. –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ NaN
- **–ú–æ–¥–µ–ª—å**: –í—ã–≤–æ–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ NaN loss
- **–¢—Ä–µ–Ω–µ—Ä**: –ü—Ä–æ–ø—É—Å–∫ –±–∞—Ç—á–µ–π —Å NaN loss
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –±–∞—Ç—á–∞—Ö

## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
```bash
python test_nan_fix.py
```

### 2. –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
```bash
make train-semantic-recommendation-safe
```

### 3. –û–±—ã—á–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ (–ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
```bash
make train-semantic-recommendation
```

## üìä –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`semantic_recommendation_experiment.yaml`)
- Learning rate: 5e-5
- Gradient clipping: 1.0
- Batch size: 2
- Mixed precision: bf16

### –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`semantic_recommendation_experiment_safe.yaml`)
- Learning rate: 1e-5
- Gradient clipping: 0.5
- Batch size: 1
- Precision: fp32 (–±–µ–∑ mixed precision)
- –ú–µ–Ω—å—à–µ —à–∞–≥–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

–ï—Å–ª–∏ NaN loss –≤—Å–µ –µ—â–µ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏**: –ò—â–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è "‚ö†Ô∏è NaN loss detected"
2. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ–Ω–∑–æ—Ä–æ–≤**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ mean/std –∑–Ω–∞—á–µ–Ω–∏–π
3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é**: –ë–æ–ª–µ–µ –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
4. **–£–º–µ–Ω—å—à–∏—Ç–µ learning rate**: –ü–æ–ø—Ä–æ–±—É–π—Ç–µ 1e-6 –∏–ª–∏ –º–µ–Ω—å—à–µ

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ:
- ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏
- ‚úÖ Forward pass –±–µ–∑ NaN
- ‚úÖ Data collator
- ‚úÖ Gradient flow –±–µ–∑ NaN

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –°–ª–µ–¥–∏—Ç–µ –∑–∞ loss –≤ –ª–æ–≥–∞—Ö
2. **Checkpoints**: –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –º–æ–¥–µ–ª—å —á–∞—â–µ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
3. **–í–∞–ª–∏–¥–∞—Ü–∏—è**: –í–∫–ª—é—á–∏—Ç–µ validation –ø–æ—Å–ª–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –æ–±—É—á–µ–Ω–∏—è
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–π—Ç–µ batch size –∏ learning rate

